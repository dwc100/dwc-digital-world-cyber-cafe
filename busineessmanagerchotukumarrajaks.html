<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DWC Advanced Product Manager (Final Version)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* =======================================
   GLOBAL RESET & FONTS
======================================= */
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:'Poppins',sans-serif;
}
body{
    background:#f5f6fa;
    color:#333;
    min-height:100vh;
}

/* =======================================
   HEADER
======================================= */
.header{
    position:fixed;
    top:0; left:0;
    width:100%;
    height:100px;
    background:linear-gradient(90deg,#6a00ff,#00b4ff,#8e2de2);
    background-size:300% 300%;
    animation:gradientMove 8s ease infinite;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 50px;
    box-shadow:0 8px 30px rgba(0,0,0,0.15);
    z-index:1000;
}
@keyframes gradientMove{
    0%{background-position:0% 50%;}
    50%{background-position:100% 50%;}
    100%{background-position:0% 50%;}
}

.logo, .user-img{
    height:70px;width:70px;
    border-radius:50%;
    object-fit:cover;
    border:2px solid #fff;
}
.title{font-size:2rem;color:white;font-weight:700;}
.user-area{display:flex;align-items:center;gap:15px;}
.username{font-size:1.2rem;font-weight:600;color:white;}

/* =======================================
   PAGE WRAPPER
======================================= */
.page{
    padding-top:150px;
    padding:30px;
    max-width:1400px;
    margin:auto;
}
h2{
    color:#4a2aff;
    margin-bottom:20px;
}

/* =======================================
   DASHBOARD CARDS
======================================= */
.cards{
    display:flex;
    gap:20px;
    margin-bottom:30px;
    flex-wrap:wrap;
}
.card{
    flex:1;
    min-width:240px;
    background:white;
    padding:20px;
    border-radius:12px;
    box-shadow:0 6px 20px rgba(0,0,0,0.1);
    text-align:center;
    font-weight:600;
}
.card span{
    display:block;
    font-size:2rem;
    margin-top:10px;
    color:#6a00ff;
}

/* =======================================
   FORMS
======================================= */
.product-form,
.discount-form,
.bill-box{
    background:white;
    padding:20px;
    border-radius:10px;
    box-shadow:0 4px 20px rgba(0,0,0,0.1);
    margin-bottom:30px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
}
.product-form input,
.discount-form input,
.bill-box input,
.bill-box select{
    padding:8px 12px;
    border-radius:5px;
    border:1px solid #ccc;
    flex:1;
    min-width:150px;
}
.product-form button,
.discount-form button,
.bill-btn{
    padding:10px 18px;
    border:none;
    border-radius:5px;
    background:#6a00ff;
    color:white;
    font-weight:700;
    cursor:pointer;
}

/* =======================================
   TABLES
======================================= */
table{
    width:100%;
    border-collapse:collapse;
    background:white;
    border-radius:8px;
    overflow:hidden;
    box-shadow:0 4px 20px rgba(0,0,0,0.1);
}
th,td{
    padding:12px 15px;
    text-align:center;
    border-bottom:1px solid #eee;
}
th{
    background:#6a00ff;
    color:white;
}
tr:hover{background:#f1f1f1;}

.btn{
    padding:6px 12px;
    border-radius:5px;
    font-weight:600;
    cursor:pointer;
}
.btn-edit{background:#00b4ff;color:white;}
.btn-delete{background:#ff4d4f;color:white;}

/* =======================================
   BILL CREATOR
======================================= */
.bill-box{
    display:block;
    margin-top:15px;
}
.bill-box label{
    font-weight:600;
    display:block;
    margin-top:10px;
}
.bill-btn{
    margin-top:10px;
    width:auto;
}

#billSummary .small{
    font-size:0.95rem;
    color:#555;
}

/* =======================================
   LOADING SCREEN
======================================= */
#loading{
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:white;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.6rem;
    font-weight:600;
    color:#6a00ff;
    z-index:5000;
}
.loader-box{text-align:center;}
.loader-circle{
    width:55px;height:55px;
    border-radius:50%;
    border:6px solid #d3c6ff;
    border-top-color:#6a00ff;
    margin:auto;
    animation:spin 1s linear infinite;
}
@keyframes spin{100%{transform:rotate(360deg);}}

/* =======================================
   PRINT TEMPLATE
======================================= */
#printTemplate table th{
    background:#f1f1f1;
}

/* YOUR SAME CSS – will send optimized version later (PART–2) */
</style>

</head>
<body>

<!-- LOADING SCREEN -->
<div id="loading">
    <div class="loader-box">
        <div class="loader-circle"></div>
        <p style="margin-top:15px;">Loading data, please wait...</p>
    </div>
</div>

<!-- HEADER -->
<header class="header">
    <img src="https://i.ibb.co/1gQKw6b/56.png" class="logo" alt="Logo">
    <h1 class="title">BIHAR INTERPRISES BUSINESS MANAGER</h1>
    <div class="user-area">
        <span class="username">Chhotu Kumar</span>
        <img src="user.jpg" class="user-img" alt="User">
    </div>
</header>

<div class="page">

<!-- Dashboard -->
<h2>Dashboard Summary</h2>
<div class="cards">
    <div class="card">Total Products <span id="totalProducts">0</span></div>
    <div class="card">Total Inventory Value <span id="totalValue">0.00</span></div>
    <div class="card">Total Revenue <span id="totalRevenue">0.00</span></div>
</div>

<!-- Add Product -->
<h2>Add New Product</h2>
<form class="product-form" id="productForm">
    <input type="text" id="prodName" placeholder="Product Name" required>
    <input type="number" id="prodQty" placeholder="Total Quantity" required>
    <input type="number" id="prodPrice" placeholder="Price per Unit" required>
    <input type="number" id="prodDiscount" placeholder="Discount %" value="0" min="0" max="100">
    <button type="submit">Add Product</button>
</form>

<!-- Inventory -->
<h2>Product Inventory</h2>
<table id="productTable">
    <thead>
        <tr>
            <th>ID</th><th>Name</th><th>Total Qty</th><th>Sold Qty</th>
            <th>Remaining</th><th>Price</th><th>Discount</th>
            <th>Amount</th><th>Revenue</th><th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Discount Calculator -->
<h2>Discount Calculator</h2>
<form class="discount-form" id="discountForm">
    <input type="number" id="itemPrice" placeholder="Item Price" required>
    <input type="number" id="discountPercent" placeholder="Discount %" required min="0" max="100">
    <button type="submit">Calculate Discount</button>
</form>

<div class="cards" style="margin-bottom:50px;">
    <div class="card">Discount Amount <span id="discountAmount">0.00</span></div>
    <div class="card">Total Payable <span id="totalPayable">0.00</span></div>
</div>

<!-- ============================================= -->
<!-- BILL CREATOR — FULL FIXED UI ADDED HERE -->
<!-- ============================================= -->

<h2 style="margin-top:40px;">Bill Creator</h2>

<!-- PATIENT BOX -->
<div id="patientFormBox" class="bill-box">
    <label>Coustomer Name</label>
    <input type="text" id="patientName" placeholder="Enter Coustomer name" style="width:100%;padding:8px;margin-top:6px;">
    <button id="patientNextBtn" class="bill-btn">Next</button>
</div>

<!-- MEDICINE BOX -->
<div id="medicineFormBox" class="bill-box" style="display:none;">
    <label>Select From Inventory</label>
    <select id="medicineSelect" style="width:100%;padding:8px;margin-top:6px;">
        <option value="">-- Select --</option>
    </select>

    <label style="margin-top:10px;">Product Name</label>
    <input type="text" id="medName" placeholder="Product Name" style="width:100%;padding:8px;">

    <label style="margin-top:10px;">Price</label>
    <input type="number" id="medPrice" placeholder="Price" style="width:100%;padding:8px;">

    <label style="margin-top:10px;">Discount %</label>
    <input type="number" id="medDiscount" value="0" style="width:100%;padding:8px;">

    <label style="margin-top:10px;">Quantity</label>
    <input type="number" id="medQty" value="1" style="width:100%;padding:8px;">

    <button id="addMedToBillBtn" class="bill-btn" style="margin-top:15px;background:#6a00ff;">Add to Bill</button>
</div>

<!-- BILL TABLE -->
<table id="billTable" style="display:none;width:100%;margin-top:20px;border-collapse:collapse;background:white;box-shadow:0 3px 10px rgba(0,0,0,0.1);">
    <thead>
        <tr>
            <th>Product</th>
            <th>Qty</th>
            <th>Unit</th>
            <th>Discount</th>
            <th>Amount</th>
            <th>Remove</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- BILL SUMMARY -->
<div id="billSummary" class="bill-box" style="display:none;"></div>

<!-- PRINT TEMPLATE -->
<div id="printTemplate" style="display:none;">
    <div id="printHeader" style="text-align:center;margin-bottom:8px;">
        <h2 style="margin:0">BIHAR INTERPRISES.</h2>
        <div id="printPatientLine" style="margin-top:6px;font-weight:600"></div>
        <div id="printDateLine" style="margin-top:4px;color:#555;font-size:0.9rem"></div>
    </div>
    <table id="printTable" style="width:100%;border-collapse:collapse;">
        <thead>
            <tr>
                <th>#</th><th>Prroduct</th><th>Qty</th>
                <th>Unit</th><th>Discount</th><th>Amount</th>
            </tr>
        </thead>
        <tbody id="printTableBody"></tbody>
        <tfoot>
            <tr><td colspan="5">Total Amount</td><td id="printTotalCell"></td></tr>
        </tfoot>
    </table>
</div>
<script type="module">

/* =========================================================
   FIREBASE CONFIG
========================================================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, set, update, get, child } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlMv0VFlcUD2s92QHfXFMqDZRK2ocVPbA",
  authDomain: "duct-manager.firebaseapp.com",
  databaseURL: "https://duct-manager-default-rtdb.firebaseio.com",
  projectId: "duct-manager",
  storageBucket: "duct-manager.firebasestorage.app",
  messagingSenderId: "643811721550",
  appId: "1:643811721550:web:44f76794dd93610ed51e1f",
  measurementId: "G-XKEQX69D0N"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* =========================================================
   GLOBALS
========================================================= */
let productList = {};      // inventory products
let billItems = [];        // items added in bill
let selectedPatient = "";  // patient name

/* SELECTORS */
const loading = document.getElementById("loading");
const productTable = document.querySelector("#productTable tbody");
const medicineSelect = document.getElementById("medicineSelect");
const billTable = document.querySelector("#billTable tbody");
const billTableBox = document.getElementById("billTable");
const billSummary = document.getElementById("billSummary");

/* =========================================================
   LOAD INVENTORY FROM FIREBASE
========================================================= */
async function loadProducts() {
    const snap = await get(child(ref(db), "products"));
    productList = snap.exists() ? snap.val() : {};

    productTable.innerHTML = "";
    medicineSelect.innerHTML = `<option value="">-- Select --</option>`;

    Object.keys(productList).forEach(id => {
        let p = productList[id];

        productTable.innerHTML += `
            <tr>
                <td>${id}</td>
                <td>${p.name}</td>
                <td>${p.qty}</td>
                <td>${p.sold}</td>
                <td>${p.qty - p.sold}</td>
                <td>${p.price}</td>
                <td>${p.discount}%</td>
                <td>${(p.final || (p.price - (p.price*p.discount/100))*p.qty).toFixed(2)}</td>
                <td>${p.revenue.toFixed(2)}</td>
                <td>
                    <button class="btn btn-delete" onclick="deleteProduct('${id}')">Delete</button>
                </td>
            </tr>
        `;

        medicineSelect.innerHTML += `<option value="${id}">${p.name}</option>`;
    });

    loading.style.display = "none";
}
loadProducts();

/* =========================================================
   ADD NEW PRODUCT
========================================================= */
document.getElementById("productForm").addEventListener("submit", async (e)=>{
    e.preventDefault();

    let name = prodName.value.trim();
    let qty  = Number(prodQty.value);
    let price = Number(prodPrice.value);
    let disc = Number(prodDiscount.value);
    let finalP = price - (price * disc / 100);

    const newRef = push(ref(db, "products"));
    await set(newRef, {
        name:name,
        qty:qty,
        sold:0,
        price:price,
        discount:disc,
        final:finalP * qty,
        revenue:0
    });

    alert("Product added!");
    prodName.value = prodQty.value = prodPrice.value = prodDiscount.value = "";
    loadProducts();
});

/* =========================================================
   DELETE PRODUCT
========================================================= */
window.deleteProduct = async function (id){
    if(confirm("Are you sure to delete this product?")){
        await set(ref(db, "products/"+id), null);
        loadProducts();
    }
};

/* =========================================================
   DISCOUNT CALCULATOR
========================================================= */
document.getElementById("discountForm").addEventListener("submit",(e)=>{
    e.preventDefault();
    let p = Number(itemPrice.value);
    let d = Number(discountPercent.value);
    let disc = p*d/100;
    let total = p - disc;

    discountAmount.textContent = disc.toFixed(2);
    totalPayable.textContent = total.toFixed(2);
});

/* =========================================================
   BILL CREATOR — STEP 1: PATIENT NAME
========================================================= */
patientNextBtn.addEventListener("click", ()=>{
    if(!patientName.value.trim()){
        alert("Enter Customer Name");
        return;
    }
    selectedPatient = patientName.value.trim();
    patientFormBox.style.display = "none";
    medicineFormBox.style.display = "block";
});

/* =========================================================
   BILL CREATOR — STEP 2: AUTOFILL ON INVENTORY SELECT
========================================================= */
medicineSelect.addEventListener("change", ()=>{
    if(!medicineSelect.value) return;

    let p = productList[medicineSelect.value];
    medName.value = p.name;
    medPrice.value = p.price;
    medDiscount.value = p.discount;
    medQty.value = 1;
});

/* =========================================================
   ADD ITEM TO BILL
========================================================= */
addMedToBillBtn.addEventListener("click", ()=>{
    if(!medName.value.trim()) return alert("Enter Product Name");

    let name = medName.value.trim();
    let price = Number(medPrice.value);
    let discount = Number(medDiscount.value);
    let qty = Number(medQty.value);
    let final = (price - (price*discount/100)) * qty;

    billItems.push({name, price, discount, qty, final});
    renderBill();

    // Reset fields
    medName.value = medPrice.value = medDiscount.value = "";
    medQty.value = 1;
    medicineSelect.value = "";
});

/* =========================================================
   RENDER BILL TABLE + SUMMARY
========================================================= */
function renderBill(){
    if(billItems.length === 0){
        billTableBox.style.display = "none";
        billSummary.style.display = "none";
        return;
    }

    billTableBox.style.display = "table";
    billSummary.style.display = "block";

    billTable.innerHTML = "";
    let total = 0;
    billItems.forEach((it,i)=>{
        total += it.final;
        billTable.innerHTML += `
        <tr>
            <td>${it.name}</td>
            <td>${it.qty}</td>
            <td>${it.price}</td>
            <td>${it.discount}%</td>
            <td>${it.final.toFixed(2)}</td>
            <td><button onclick="removeBillItem(${i})" class="btn btn-delete">X</button></td>
        </tr>
        `;
    });

    billSummary.innerHTML = `
        <h3>Bill Summary</h3>
        <p><b>Customer Name:</b> ${selectedPatient}</p>
        <p><b>Total:</b> ₹${total.toFixed(2)}</p>
        <button class="bill-btn" style="background:#00b44e" onclick="saveAndPrint()">Save & Print</button>
    `;
}

/* =========================================================
   REMOVE ITEM FROM BILL
========================================================= */
window.removeBillItem = function(i){
    billItems.splice(i,1);
    renderBill();
};

/* =========================================================
   SAVE BILL + INVENTORY UPDATE + PRINT
========================================================= */
window.saveAndPrint = async function(){

    if(billItems.length === 0){
        alert("No items in bill");
        return;
    }

    // UPDATE INVENTORY
    for(let it of billItems){
        for(let id of Object.keys(productList)){
            if(productList[id].name === it.name){
                let sold = productList[id].sold + it.qty;
                let revenue = productList[id].revenue + it.final;
                let finalTotal = (productList[id].price - (productList[id].price*productList[id].discount/100)) * productList[id].qty;
                await update(ref(db,"products/"+id),{
                    sold:sold,
                    revenue:revenue,
                    final:finalTotal
                });
            }
        }
    }

    // SAVE BILL
    await push(ref(db,"bills"),{
        customer:selectedPatient,
        items:billItems,
        total: billItems.reduce((a,b)=>a+b.final,0),
        date:new Date().toLocaleString()
    });

    printBill();
    billItems = [];
    renderBill();
};

/* =========================================================
   PRINT BILL
========================================================= */
function printBill(){
    let total = 0;
    let html = `
    <h3 style="text-align:center;">BIHAR ENTERPRISES</h3>
    <p><b>Customer:</b> ${selectedPatient}</p>
    <p>${new Date().toLocaleString()}</p>
    <table border="1" style="width:100%;border-collapse:collapse;margin-top:10px;">
        <tr>
            <th>PRODUCT</th><th>Qty</th><th>Unit</th>
            <th>Discount</th><th>Amount</th>
        </tr>
    `;

    billItems.forEach(it=>{
        total += it.final;
        html += `
            <tr>
                <td>${it.name}</td>
                <td>${it.qty}</td>
                <td>${it.price}</td>
                <td>${it.discount}%</td>
                <td>${it.final.toFixed(2)}</td>
            </tr>
        `;
    });

    html += `
        <tr>
            <td colspan="4"><b>Total Amount</b></td>
            <td><b>${total.toFixed(2)}</b></td>
        </tr>
    </table>`;

    let w = window.open();
    w.document.write(html);
    w.print();
    w.close();
}

</script>


<!-- ================= JS COMES IN PART–3 ================= -->

</body>
</html>

