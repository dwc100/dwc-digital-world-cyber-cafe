<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DWC Medical Shop — Inventory & Billing</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif}
body{background:#f5f6fa;color:#222;min-height:100vh}
.header{position:fixed;top:0;left:0;width:100%;height:100px;background:linear-gradient(90deg,#6a00ff,#00b4ff,#8e2de2);background-size:300% 300%;animation:gradientMove 8s ease infinite;display:flex;align-items:center;justify-content:space-between;padding:0 30px;box-shadow:0 8px 30px rgba(0,0,0,0.15);z-index:1000}
@keyframes gradientMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.title{color:white;font-weight:700;font-size:1.6rem}
.page{padding-top:140px;max-width:1200px;margin:0 auto;padding:30px}
.container{display:grid;grid-template-columns:1fr 420px;gap:20px}
.card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
.section-title{color:#4a2aff;margin-bottom:12px;font-weight:700}
.form-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.form-row input, .form-row select{flex:1;padding:8px 10px;border-radius:6px;border:1px solid #ddd}
.btn{padding:8px 12px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
.btn-primary{background:#6a00ff;color:#fff}
.btn-danger{background:#ff4d4f;color:#fff}
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th, .table td{padding:10px;text-align:left;border-bottom:1px solid #eee}
.small{font-size:0.9rem}
.summary{display:flex;flex-direction:column;gap:6px;margin-top:12px}
.summary .row{display:flex;justify-content:space-between}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f1f1}
.footer-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
#loading{position:fixed;top:0;left:0;width:100%;height:100%;background:white;display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:#6a00ff;z-index:5000}
@media(max-width:980px){.container{grid-template-columns:1fr;}.header{padding:0 12px}}
</style>
</head>
<body>
<div id="loading">Loading app...</div>
<header class="header">
  <div class="title">DWC Medical Shop — Inventory & Billing</div>
  <div style="color:white;font-weight:600">Kumar Medical Store</div>
</header>
<div class="page">
  <div class="container">
    <!-- LEFT: Inventory + Medicines -->
    <div>
      <div class="card">
        <div class="section-title">Medicine Inventory</div>
        <form id="medForm" class="form-row">
          <input id="mName" placeholder="Medicine Name" required>
          <input id="mStock" type="number" placeholder="Stock" min="0" required>
          <input id="mUnitPrice" type="number" placeholder="Unit Price" min="0" step="0.01" required>
          <input id="mDiscount" type="number" placeholder="Discount % (0)" min="0" max="100" value="0">
          <button class="btn btn-primary" id="addMed">Add / Update</button>
        </form>
        <table class="table" id="medTable">
          <thead><tr><th>Name</th><th>Stock</th><th>Unit</th><th>Disc%</th><th>Final</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="height:18px"></div>
      <div class="card">
        <div class="section-title">Dashboard Summary</div>
        <div class="summary">
          <div class="row"><div>Total Medicines</div><div class="badge" id="totalM">0</div></div>
          <div class="row"><div>Total Stock Value</div><div class="badge" id="stockValue">0.00</div></div>
          <div class="row"><div>Total Revenue (sold)</div><div class="badge" id="totalRevenue">0.00</div></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Billing Panel -->
    <div>
      <div class="card">
        <div class="section-title">Create Bill</div>
        <div class="form-row">
          <input id="patientName" placeholder="Patient Name" required>
          <input id="patientMobile" placeholder="Mobile (optional)">
        </div>
        <div style="border:1px dashed #eee;padding:10px;border-radius:8px">
          <div class="form-row">
            <select id="medicineSelect"><option value="">-- Select Medicine --</option></select>
            <input id="billQty" type="number" placeholder="Qty" min="1" value="1">
            <input id="billUnitPrice" type="number" placeholder="Unit Price" min="0" step="0.01">
            <input id="billDisc" type="number" placeholder="Disc %" min="0" max="100" value="0">
            <button id="addToBill" class="btn btn-primary">Add</button>
          </div>
          <div class="small" style="margin-top:6px;color:#666">Tip: Select medicine to auto-fill price. You can change unit price & discount before adding.</div>
        </div>

        <table class="table" id="billTable">
          <thead><tr><th>Medicine</th><th>Qty</th><th>Unit</th><th>Disc%</th><th>Amount</th><th></th></tr></thead>
          <tbody></tbody>
        </table>

        <div class="summary" style="margin-top:10px">
          <div class="row"><div>Total Items</div><div class="badge" id="billItems">0</div></div>
          <div class="row"><div>Gross Amount</div><div class="badge" id="grossAmt">0.00</div></div>
          <div class="row"><div>Total Discount</div><div class="badge" id="totalDisc">0.00</div></div>
          <div class="row"><div><strong>Net Payable</strong></div><div class="badge" id="netPay">0.00</div></div>
        </div>

        <div class="footer-actions">
          <button id="clearBill" class="btn">Clear</button>
          <button id="saveBill" class="btn btn-primary">Save & Preview Bill</button>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="card small">
        <div class="section-title">Saved Bills (recent)</div>
        <ul id="recentBills" style="list-style:none;padding-left:0;max-height:200px;overflow:auto"></ul>
      </div>
    </div>
  </div>
</div>

<!-- Firebase v12 -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove, set, get, child } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlMv0VFlcUD2s92QHfXFMqDZRK2ocVPbA",
  authDomain: "duct-manager.firebaseapp.com",
  databaseURL: "https://duct-manager-default-rtdb.firebaseio.com",
  projectId: "duct-manager",
  storageBucket: "duct-manager.firebasestorage.app",
  messagingSenderId: "643811721550",
  appId: "1:643811721550:web:44f76794dd93610ed51e1f",
  measurementId: "G-XKEQX69D0N"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const medsRef = ref(db, 'medicines/');
const billsRef = ref(db, 'bills/');

// Elements
const loading = document.getElementById('loading');
const medForm = document.getElementById('medForm');
const mName = document.getElementById('mName');
const mStock = document.getElementById('mStock');
const mUnitPrice = document.getElementById('mUnitPrice');
const mDiscount = document.getElementById('mDiscount');
const medTableBody = document.querySelector('#medTable tbody');
const totalM = document.getElementById('totalM');
const stockValue = document.getElementById('stockValue');
const totalRevenue = document.getElementById('totalRevenue');

const medicineSelect = document.getElementById('medicineSelect');
const billQty = document.getElementById('billQty');
const billUnitPrice = document.getElementById('billUnitPrice');
const billDisc = document.getElementById('billDisc');
const addToBillBtn = document.getElementById('addToBill');
const billTableBody = document.querySelector('#billTable tbody');
const billItemsEl = document.getElementById('billItems');
const grossAmtEl = document.getElementById('grossAmt');
const totalDiscEl = document.getElementById('totalDisc');
const netPayEl = document.getElementById('netPay');
const clearBill = document.getElementById('clearBill');
const saveBill = document.getElementById('saveBill');
const patientName = document.getElementById('patientName');
const patientMobile = document.getElementById('patientMobile');
const recentBills = document.getElementById('recentBills');

let medicines = {}; // key -> {name, stock, price, discount, finalPrice, sold}
let billItems = []; // [{key, name, qty, unit, disc, amount}]
let firebaseLoaded = false;

setTimeout(()=>{ if(!firebaseLoaded){ loading.style.display='none'; alert('Firebase load timeout — check config/rules'); } }, 5000);

// Listen medicines
onValue(medsRef, snap => {
  firebaseLoaded = true; loading.style.display='none';
  medicines = {};
  medTableBody.innerHTML = '';
  medicineSelect.innerHTML = '<option value="">-- Select Medicine --</option>';
  let count = 0; let stockVal = 0; let revenue = 0;
  snap.forEach(child => {
    const key = child.key; const data = child.val();
    medicines[key] = data;
    addMedRow(key, data);
    medicineSelect.insertAdjacentHTML('beforeend', `<option value="${key}">${escapeHtml(data.name)} (₹${parseFloat(data.finalPrice).toFixed(2)})</option>`);
    count++;
    stockVal += (parseFloat(data.finalPrice) * (parseInt(data.stock || 0)));
    revenue += (parseFloat(data.finalPrice) * (parseInt(data.sold || 0)));
  });
  totalM.innerText = count;
  stockValue.innerText = stockVal.toFixed(2);
  totalRevenue.innerText = revenue.toFixed(2);
});

// Recent bills
onValue(billsRef, snap => {
  recentBills.innerHTML = '';
  let idx = 0;
  snap.forEach(child => {
    if(idx++>9) return; // show up to 10
    const b = child.val();
    const li = document.createElement('li');
    li.style.padding='8px 6px'; li.style.borderBottom='1px solid #f1f1f1';
    li.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(b.patient||'—')}</strong><div class=\"small\">${new Date(b.time).toLocaleString()}</div></div><div>₹${parseFloat(b.net).toFixed(2)}</div></div>`;
    li.addEventListener('click', ()=> openBillPreview(b));
    recentBills.appendChild(li);
  });
});

// Add medicine
medForm.addEventListener('submit', e => {
  e.preventDefault();
  const name = mName.value.trim();
  const stock = parseInt(mStock.value) || 0;
  const unit = parseFloat(mUnitPrice.value) || 0;
  const disc = parseFloat(mDiscount.value) || 0;
  if(!name){alert('Enter medicine name');return}
  const finalPrice = (unit - unit * disc / 100).toFixed(2);
  // Check if medicine exists by exact name
  const existingKey = Object.keys(medicines).find(k=>medicines[k].name.toLowerCase()===name.toLowerCase());
  if(existingKey){
    // update stock & price
    update(ref(db, 'medicines/' + existingKey), { stock, price:unit, discount:disc, finalPrice });
  } else {
    push(medsRef, { name, stock, price:unit, discount:disc, finalPrice, sold:0 });
  }
  medForm.reset();
});

function addMedRow(key, data){
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${escapeHtml(data.name)}</td><td>${data.stock||0}</td><td>₹${parseFloat(data.price||0).toFixed(2)}</td><td>${data.discount||0}%</td><td>₹${parseFloat(data.finalPrice||0).toFixed(2)}</td><td><button data-key="${key}" class="btn btn-primary small edit">Edit</button> <button data-key="${key}" class="btn btn-danger small delete">Delete</button></td>`;
  medTableBody.appendChild(tr);
  tr.querySelector('.delete').addEventListener('click', ()=>{
    if(confirm('Delete this medicine?')) remove(ref(db,'medicines/'+key));
  });
  tr.querySelector('.edit').addEventListener('click', ()=>{
    mName.value = data.name; mStock.value = data.stock; mUnitPrice.value = data.price; mDiscount.value = data.discount||0;
  });
}

// When medicine selected autofill price
medicineSelect.addEventListener('change', ()=>{
  const k = medicineSelect.value;
  if(!k){ billUnitPrice.value=''; billDisc.value='0'; return; }
  const m = medicines[k];
  billUnitPrice.value = parseFloat(m.price).toFixed(2);
  billDisc.value = m.discount||0;
});

// Add to bill
addToBillBtn.addEventListener('click', e=>{
  e.preventDefault();
  const medKey = medicineSelect.value;
  const qty = parseInt(billQty.value) || 0;
  const unit = parseFloat(billUnitPrice.value) || 0;
  const disc = parseFloat(billDisc.value) || 0;
  if(!medKey){alert('Select medicine');return}
  if(qty<=0){alert('Enter qty');return}
  // check stock
  const medData = medicines[medKey];
  if(medData.stock < qty){ if(!confirm('Stock less than requested. Add anyway?')) return }
  const finalUnit = (unit - unit*disc/100);
  const amount = +(finalUnit * qty).toFixed(2);
  const item = { key:medKey, name:medData.name, qty, unit, disc, amount };
  billItems.push(item);
  renderBillTable();
});

function renderBillTable(){
  billTableBody.innerHTML = '';
  let gross = 0, tDisc = 0;
  billItems.forEach((it, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(it.name)}</td><td>${it.qty}</td><td>₹${it.unit.toFixed(2)}</td><td>${it.disc}%</td><td>₹${it.amount.toFixed(2)}</td><td><button data-idx="${idx}" class="btn small">Remove</button></td>`;
    billTableBody.appendChild(tr);
    tr.querySelector('button').addEventListener('click', ()=>{ billItems.splice(idx,1); renderBillTable(); });
    gross += it.unit * it.qty;
    tDisc += (it.unit * it.qty) - it.amount;
  });
  billItemsEl.innerText = billItems.length;
  grossAmtEl.innerText = gross.toFixed(2);
  totalDiscEl.innerText = tDisc.toFixed(2);
  netPayEl.innerText = (gross - tDisc).toFixed(2);
}

clearBill.addEventListener('click', ()=>{ if(confirm('Clear current bill?')){ billItems = []; renderBillTable(); patientName.value=''; patientMobile.value=''; } });

saveBill.addEventListener('click', async ()=>{
  if(!patientName.value.trim()){ if(!confirm('Patient name empty. Continue?')) return }
  if(billItems.length===0){ alert('Bill empty'); return }
  const time = Date.now();
  const gross = parseFloat(grossAmtEl.innerText)||0;
  const tDisc = parseFloat(totalDiscEl.innerText)||0;
  const net = parseFloat(netPayEl.innerText)||0;
  const billObj = { patient: patientName.value.trim(), mobile: patientMobile.value.trim(), items: billItems, gross, discount:tDisc, net, time };
  try{
    const newRef = await push(billsRef, billObj);
    // update stock & sold
    for(const it of billItems){
      const key = it.key;
      const med = medicines[key];
      if(!med) continue;
      const newStock = (parseInt(med.stock||0) - parseInt(it.qty));
      const newSold = (parseInt(med.sold||0) + parseInt(it.qty));
      await update(ref(db, 'medicines/' + key), { stock: newStock, sold: newSold });
    }
    // reset
    const savedBill = Object.assign({ id: newRef.key }, billObj);
    billItems = [];
    renderBillTable(); patientName.value=''; patientMobile.value='';
    openBillPreview(savedBill);
  } catch(err){ alert('Error saving bill: '+err.message) }
});

function openBillPreview(bill){
  const win = window.open('', '_blank', 'width=800,height=900');
  const shopName = 'Kumar Medical Store';
  const shopName = 'Kumar Medical Store';
  const address = 'Address: Your Address Here';
  const billHtml = `<!doctype html><html><head><meta charset="utf-8"><title>Bill - ${escapeHtml(bill.patient||'')}</title><style>body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#111}h2{margin-bottom:4px}table{width:100%;border-collapse:collapse;margin-top:10px}th,td{padding:8px;border-bottom:1px solid #ddd;text-align:left}thead th{background:#f7f7f7}footer{margin-top:10px;font-size:0.95rem} .right{float:right}</style></head><body><div><h2>${shopName}</h2><div>${address}</div><hr><div><strong>Patient:</strong> ${escapeHtml(bill.patient||'—')} <span class="right"><strong>Date:</strong> ${new Date(bill.time).toLocaleString()}</span></div><table><thead><tr><th>#</th><th>Medicine</th><th>Qty</th><th>Unit</th><th>Disc%</th><th>Amount</th></tr></thead><tbody>${bill.items.map((it,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(it.name)}</td><td>${it.qty}</td><td>₹${it.unit.toFixed(2)}</td><td>${it.disc}%</td><td>₹${it.amount.toFixed(2)}</td></tr>`).join('')}</tbody></table><div style="text-align:right;margin-top:10px"><div>Gross: ₹${bill.gross.toFixed(2)}</div><div>Discount: ₹${bill.discount.toFixed(2)}</div><div style="font-weight:700">Net: ₹${bill.net.toFixed(2)}</div></div><hr><div style="margin-top:20px;text-align:center">Thanks for visiting!</div><div style="margin-top:10px;text-align:center"><button onclick="window.print()">Print</button></div></div></body></html>`;
  win.document.write(billHtml);
  win.document.close();
}

function escapeHtml(str){ if(!str && str!==0) return ''; return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[s]); }

</script>
</body>
</html>